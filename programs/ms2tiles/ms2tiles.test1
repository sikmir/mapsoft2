#!/bin/bash -efu


P=${1:-./ms2tiles}

. ../../modules/test_lib.sh

help_msg="$($P -h ||:)"
assert_cmd "$P" "$help_msg" 1
assert_cmd "$P -h" "$help_msg" 1
assert_cmd "$P --help" "$help_msg" 1
assert_cmd "$P --xxx " "Error: unknown option: --xxx" 1
assert_cmd "$P --range a" "Error: z-index is not set" 1

assert_cmd "$P --range [24.94,60.17] -z 1 a" "Error: unexpected value: a" 1

assert_cmd "$P    -r [24.94,60.17] -z 10" "[582,727,1,1]" 0
assert_cmd "$P -G -r [24.94,60.17] -z 10" "[582,296,1,1]" 0
assert_cmd "$P    -r [24.94,60.17,1,1] -z 10" "[582,727,4,7]" 0
assert_cmd "$P -G -r [24.94,60.17,1,1] -z 10" "[582,290,4,7]" 0

assert_cmd "$P    --cover [24.94,60.17] -z 10" "[582,727,10]" 0
assert_cmd "$P -G --cover [24.94,60.17] -z 10" "[582,296,10]" 0
assert_cmd "$P    --cover [24.94,60.17,0.3,0.3] -z 10" \
"[582,727,10]
[583,727,10]
[582,728,10]
[583,728,10]
[582,729,10]
[583,729,10]" 0
assert_cmd "$P -G --cover [24.94,60.17,0.3,0.3] -z 10" \
"[582,294,10]
[583,294,10]
[582,295,10]
[583,295,10]
[582,296,10]
[583,296,10]" 0

####

# border with two parts and a hole:
brd="[[[35.04364,54.509921],[35.065613,54.90662],[35.867615,54.893985],[35.845642,54.501948]],
[[36.471863,54.939766],[37.034912,54.492377],[38.968506,54.689709],[38.943787,56.520109],[36.496582,56.532229]],
[[37.089844,55.338518],[38.204956,55.326019],[38.199463,55.943048],[37.122803,55.952275]]]"

res="[307,158,9]
[308,158,9]
[309,158,9]
[310,158,9]
[311,158,9]
[307,159,9]
[308,159,9]
[309,159,9]
[310,159,9]
[311,159,9]
[307,160,9]
[308,160,9]
[310,160,9]
[311,160,9]
[307,161,9]
[308,161,9]
[309,161,9]
[310,161,9]
[311,161,9]
[305,162,9]
[306,162,9]
[307,162,9]
[308,162,9]
[309,162,9]
[310,162,9]
[311,162,9]
[305,163,9]
[306,163,9]
[308,163,9]
[309,163,9]"

assert_cmd "$P --cover \"$brd\" -z 9 -G" "$res" 0
assert_cmd "$P --cover test_data/tile_test.gpx -z 9 -G" "$res" 0

assert_cmd "$P --range \"$brd\" -z 9 -G" "[305,158,7,6]" 0
assert_cmd "$P --range test_data/tile_test.gpx -z 9 -G" "[305,158,7,6]" 0

assert_cmd "$P -t [308,158,9] --range \"$brd\" -z 9 -G" "" 0
assert_cmd "$P -t [309,160,9] --range \"$brd\" -z 9 -G" "" 0
assert_cmd "$P -t [1,1,9]     --range \"$brd\" -z 9 -G" "" 1

assert_cmd "$P -t [308,158,9] --cover \"$brd\" -z 9 -G" "" 0
assert_cmd "$P -t [309,160,9] --cover \"$brd\" -z 9 -G" "" 1
assert_cmd "$P -t [1,1,9]     --cover \"$brd\" -z 9 -G" "" 1

####

assert_cmd "$P -t [582,727] -z 10" "[24.609375,60.0648405,0.3515625,0.17497071]" 0
assert_cmd "$P -t [582,727] -z 10 -c " "[24.7851562,60.1523258]" 0

assert_cmd "$P -t [582,727] -z 10 -r [24,60,1,1]" "" 0
assert_cmd "$P -t [582,727] -z 10 -r [24,60,0.61,1]" "" 0
assert_cmd "$P -t [582,727] -z 10 -r [24,60,0.60,1]" "" 1
assert_cmd "$P -t [582,727] -z 10 -r [25,60,1,1]" "" 1
